# -*- coding: utf-8 -*-

# 44 个预定义场景
SCENE_LIST = [
    "地图导航",
    "打车服务",
    "即时通信聊天服务",
    "电话通话",
    "网络社区",
    "网络支付",
    "网上购物",
    "餐饮外卖",
    "邮寄服务",
    "交通票务",
    "婚恋相亲",
    "求职招聘",
    "网络借贷",
    "房屋租售",
    "汽车交易",
    "医疗健康",
    "旅游服务",
    "酒店预定",
    "网络游戏",
    "学习教育",
    "维修装修",
    "女性健康",
    "汽车单车租赁",
    "投资理财",
    "手机银行",
    "网络邮箱",
    "远程会议",
    "网络直播",
    "在线影音",
    "新闻资讯",
    "运动健身",
    "浏览器",
    "杀毒软件",
    "电子图书",
    "拍摄美化",
    "应用商店",
    "天气",
    "日历",
    "实用工具",
    "文件管理",
    "娱乐票务",
    "用户登录",
    "其他",
    "广告",
    "个人信息"
]

# 识别场景的 Prompt（v4：intent + top1 + top3 + top5 + top7）
SCENE_PROMPT = """
你是一名专业的安卓权限合规与功能理解专家，你的任务是根据给定的一段 UI 交互链，判断它属于哪一种应用功能场景，并给出有层次的候选场景列表。

【已知场景列表（共 44 类）】
{SCENE_LIST}

这些场景的大致含义示例（仅用于帮助你理解，分类时仍必须从上面 44 个名称中选择）：
- 地图导航：地图展示、位置搜索、路线规划、导航等
- 打车服务：网约车/出租车叫车、出行下单、行程与司机信息
- 即时通信聊天服务：聊天列表、对话窗口、发送文字/语音/表情等
- 电话通话：拨号盘、通话记录、来电/去电界面、网络电话
- 网络社区：论坛、帖子流、评论区、关注/点赞/转发等
- 网络支付：收付款、转账、充值提现、支付记录
- 网上购物：商品列表、商品详情、加入购物车、下单、订单页
- 餐饮外卖：餐厅列表、菜品选择、外卖下单、配送信息
- 交通票务：机票/火车票/车票/出行行程的搜索、预订、改签
- 求职招聘：职位列表、职位详情、简历投递、简历管理
- 网络借贷 / 投资理财 / 手机银行：账户信息、资产展示、交易记录、申购/赎回等金融操作
- 房屋租售 / 汽车交易：房源/车源列表与详情、发布与管理
- 旅游服务 / 酒店预定：景点/路线/酒店搜索与预订
- 网络游戏：游戏大厅、匹配、对局界面、道具购买等
- 学习教育：课程列表、课程详情、在线课堂、题目练习
- 网络直播 / 在线影音：直播间、弹幕、礼物打赏、视频/音频播放页面
- 浏览器：地址栏、搜索框、网页内容显示
- 拍摄美化：相机取景、滤镜、美颜、扫码、相册编辑
- 文件管理：文件/图片/视频/下载内容的浏览、管理、分享
- 用户登录：注册、登录、验证码输入、账号密码输入等
- 广告：明显推广文案、跳转按钮、非主要功能的插入广告
- 实用工具：如手机优化、清理加速、WiFi 管理、电池管理等通用工具类功能
- 其他：无法可靠归入上述任何一类，或功能极不明确的页面

【输入说明】
你将收到一个由多帧 UI 组成的交互链，每一帧包含：
- [TEXT]：该帧页面 OCR 识别出的主要文字
- [WIDGETS]：该帧中重要控件（按钮、标题、菜单项等）的文本
- 以及一个 [META] 段，可能包含：
  - APP package: 应用包名
  - Requested permissions: 该交互链涉及到的敏感权限列表（例如 CAMERA, READ_EXTERNAL_STORAGE 等）
  - Likely scenes based on permissions: 根据权限自动推测出的“可能场景”（仅作为先验提示）

这些帧按时间顺序排列，通常包含：
1. 权限弹窗弹出之前的界面（[BEFORE]）
2. 权限弹窗本身（[GRANTING]，可能为 1～多帧）
3. 用户授权/拒绝后的界面（[AFTER]）

请综合整段交互链来判断功能场景，不要只看单一按钮文案。

【利用权限先验的约束（非常重要）】
- 如果 Requested permissions 中出现与“存储、相册、读取/写入外部存储”相关的权限
  （如 READ_EXTERNAL_STORAGE、WRITE_EXTERNAL_STORAGE、READ_MEDIA_IMAGES 等），
  且界面内容与文件/图片/视频的选择、管理、分享等明显相关，
  则更倾向于将该交互链归为「文件管理」场景，而不是“泛泛的实用工具”。
- 如果 Requested permissions 中出现 CAMERA 或其他与拍照/扫码相关的权限，
  且界面与拍照、相机取景、滤镜、美颜、扫码等有关，
  则更倾向于将该交互链归为「拍摄美化」场景，而不是一般的“在线影音”或“实用工具”。
- 如果没有任何敏感权限，或者只出现如网络状态、WiFi 控制等权限，
  且界面主要用于清理、优化、加速、WiFi 管理等通用系统维护功能，
  则更倾向于将该交互链归为「实用工具」。
- 如果权限与位置（ACCESS_FINE_LOCATION / ACCESS_COARSE_LOCATION）高度相关，
  且页面包含附近、定位、地图、路线等信息，
  则优先考虑「地图导航」或与位置强相关的出行场景，而不是无关类别。

在做判断时，你应当：
- 综合 [META] 中的权限与先验提示；
- 结合 BEFORE / GRANTING / AFTER 的文本内容、按钮功能和上下文目标；
- 优先保证场景与权限组合在真实业务上“合理”，避免出现明显不匹配的组合。

【输出要求】
你需要输出一个 JSON 对象，包含以下字段：

1. "intent"：用简短的一句话，用中文概括该交互链的核心功能意图，例如：
   - "用户正在为拍照上传头像而授予相机和存储权限"
   - "用户在使用文件清理工具，需要访问本地存储中的文件列表"
   - "用户在地图中查看附近的 WiFi 热点，需要位置权限"
   这句话应当与后面的场景分类相一致。

2. "top1"：从 44 个场景中选出你认为**最匹配**的 1 个场景名称。

3. "top3"：一个长度为 3 的场景候选列表，要求：
   - "top3" 必须包含 **3 个互不相同** 的场景名称；
   - 这 3 个场景都必须来自上面给出的 44 个场景名称；
   - "top1" 必须出现在 "top3" 中，并且是 "top3" 的第一个元素；
   - 其余两个场景应该是在信息有限时、你认为也“有一定可能”的备选场景。

4. "top5"：一个长度为 5 的候选列表，要求：
   - 所有元素互不相同；
   - 所有元素都必须来自 44 个场景名称；
   - 必须包含 "top1" 和 "top3" 中的全部 3 个场景；
   - 另外 2 个场景可以是你认为次优但仍然有一定相关性的场景；
   - 如果你觉得合理的候选数量不足 5 个，也仍然要补足，用最不确定但稍有相关性的场景填满。

5. "top7"：一个长度为 7 的候选列表，要求：
   - 所有元素互不相同；
   - 所有元素都必须来自 44 个场景名称；
   - 必须包含 "top5" 中的全部 5 个场景；
   - 另外 2 个场景可以用于覆盖你认为“极端情况下也有可能”的远端备选；
   - 同样，即使你非常有信心，也必须补足到 7 个。

【必须严格遵守的 JSON 输出格式】（不得包含任何额外文本、注释或说明）：

{{
  "intent": "一句话功能意图",
  "top1": "场景名称",
  "top3": ["场景1", "场景2", "场景3"],
  "top5": ["场景1", "场景2", "场景3", "场景4", "场景5"],
  "top7": ["场景1", "场景2", "场景3", "场景4", "场景5", "场景6", "场景7"]
}}

所有字符串必须使用双引号，场景名称必须严格来自 44 个预定义场景名称。

现在是待分析的 UI 特征：
{FEATURE}
"""

# ===========================
# 本地 LLM 配置
# ===========================
VLLM_URL = "http://localhost:8002/v1/chat/completions"
MODEL_NAME = "Qwen2.5-7B"

# ===========================
# 超参（可按需要微调）
# ===========================
MAX_STEPS = 10        # before + granting + after 保留的最大步骤
MAX_WIDGETS = 20      # 每个界面最多取多少 widgets
MAX_TEXT_LEN = 4000    # 每段文本最大长度
MAX_TOTAL_LEN = 30000 # 最终输入给 LLM 的最大字符数（安全上限）